{% extends '::base.html.twig' %}

{% block plugins %}
<script src="assets/plugins/bootstrap-daterangepicker/date.js" type="text/javascript"></script>
<script src="assets/plugins/bootstrap-daterangepicker/daterangepicker.js" type="text/javascript"></script> 
<script src="assets/plugins/highcharts/highcharts.js" type="text/javascript"></script>
<script src="assets/plugins/highcharts/modules/exporting.js" type="text/javascript"></script>
<script src="/assets/scripts/autobahn.min.js"></script>
{% endblock %}

{% block javascript %}
{% block ajax_update_item %}
<script type="text/javascript">
    function update_item(data)
    {
        $('.item_name').val(data.name);
        $('.item_name_text').html(data.name);
        $('.item_delete_button').html('Delete All Data for: ' + data.name);
        $('.item_status').val(data.status);
    }
</script>
{% endblock %}

<script>
jQuery(document).ready(function() {
    console.log('connecting to websocket server');
    var conn = new ab.Session(
        'ws://{{ app.request.host }}:8080',
        function() { // connect
            console.log('connected');
            conn.subscribe('client:{{ client.getID }}', function(topic, data) {
                console.log('New article published to category "' + topic + '"');

                var log = data.logentry;
                console.log(log);
                var log_id = 'log_' + log.call_id;

                // remove old rows (from answer script)
                $('#' + log_id).fadeOut('slow', function() {
                    $(this).remove();
                });

                var row = '<tr id="' + log_id + '" style="display: none;"><td>' + log.origin_number + '</td>';
                row += '<td>' + log.dialled_number + '</td>';
                row += '<td>' + log.destination_number + '</td>';
                row += '<td>' + log.date_start.time + '<br /><small>' + log.date_start.date + '</small></td>';
                row += '<td>' + log.date_end.time + '<br /><small>' + log.date_end.date + '</small></td>';
                row += '<td>' + log.duration + 's</td>';
                row += '<td>' + log.hangup_cause + '</td>';
                row += '<td>' + log.advert_name + '</td>';
                row += '<td>' + log.adgroup_name + '</td>';
                row += '<td>' + log.campaign_name + '</td>';
                row += '</tr>';

                // add updated rows (from hangup)
                $(row).prependTo('#logbody').fadeIn('slow');
            });
        },
        function() { // close
            console.warn('WebSocket connection closed');
        },
        { // extra parameters
            'skipSubprotocolCheck': true
        }
    );
});
</script>
{% endblock %}

{% block body %}
<div class="container-fluid">
<!-- START CAMPAIGNS -->
    <div class="row-fluid">
        <div class="span12">
            <!-- BEGIN PAGE TITLE & BREADCRUMB-->
            <h3 class="page-title">Call Log</h3>
            {{ flash.display_flash_messages }}
            <ul class="breadcrumb">
                <li>
                    {{ client.getName }}
                    <i class="icon-angle-right"></i>
                </li>
                <li>
                    Call Log
                </li>
            </ul>

            <!-- END PAGE TITLE & BREADCRUMB-->
        </div>
    </div>
    <!-- END PAGE HEADER-->
    <!-- BEGIN PAGE CONTENT-->
    <div class="row-fluid">
        <div class="span12">
            <!-- BEGIN SAMPLE TABLE PORTLET-->
                <div class="controls">
                    <!-- Kendrick: Live updates should respect any filters that are set -->
                    <h4>Live Updates</h4>
                    <div class="portlet-body no-more-tables">
                        <table class="table-bordered table-striped table-condensed cf">
                            <thead class="cf">
                                <tr>
                                    <th style="width: 114px;">Caller Number</th> 
                                    <th style="width: 114px;">Dialled Number</th>
                                    <th style="width: 114px;">Destination</th>
                                    <th style="width: 73px;">Start Time</th>
                                    <th style="width: 114px;">End Time</th>
                                    <th>Duration</th>
                                    <!--
                                    {% if is_granted('ROLE_PREVIOUS_ADMIN') %}
                                        <th>Cost (HKD)</th>
                                    {% endif %}
                                    -->
                                    <th style="width: 114px;">Hangup Cause</th>
                                    <th style="width: 114px;">Advert</th>
                                    <th style="width: 114px;">AdGroup</th>
                                    <th style="width: 114px;">Campaign</th>
                                </tr>
                            </thead>
                            <tbody id="logbody">
                            {% for log in logs %}
                                <tr>
                                    <td data-title="Caller Number">{{ log.getOriginNumber }}</td>  
                                    <td data-title="Dialled Number">{{ log.getDialledNumber }}</td>  
                                    <td data-title="Destination Number">{{ log.getDestinationNumber }}</td>
                                    <td data-title="Call Start Time">
                                    {{ log.getDateStart.format('H:i:s') }}<br /><small>{{ log.getDateStart.format('M d Y') }}</small>
                                    </td>  
                                    <td data-title="Call End Time">
                                    {{ log.getDateEnd.format('H:i:s') }}<br /><small>{{ log.getDateEnd.format('M d Y') }}</small>
                                    </td>
                                    <td data-title="Duration">{{ log.getDuration }}s</td>
                                    <!--
                                    {% if is_granted('ROLE_PREVIOUS_ADMIN') %}
                                        <td data-title="Cost">{{ log.getBillRate }}</td>
                                    {% endif %}
                                    -->
                                    <td data-title="Hangup Cause">{{ log.getHangupCause }}</td>
                                    <td data-title="Advert"><a href="/adgroup/{{ log.getAdGroupID() }}/adverts">{{ log.getAdvert.getName }}</a></td>
                                    <td data-title="AdGroup"><a href="/campaign/{{ log.getCampaignID() }}/adgroups">{{ log.getAdGroup.getName }}</a></td>
                                    <td data-title="Campaign"><a href="/client/{{ log.getClientID() }}/campaigns">{{ log.getCampaign.getName }}</a></td>
                                </tr>  
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            <!-- END SAMPLE TABLE PORTLET-->
        </div>
    </div>
    <!-- END CAMPAIGNS -->
</div>
{% endblock %}
